name: Release — Build, Test & Push to Docker Hub

# ─────────────────────────────────────────────────────────────────────────────
# RELEASE WORKFLOW  (tag-based + GitHub Release + manual dispatch)
# ───────────────────────────────────────────────────────────────
# This workflow handles ALL tag events.  Behaviour differs by origin branch:
#
#   Semver tag pushed from  dev   →  validate-tag + test  (no Docker push)
#   Semver tag pushed from  main  →  validate-tag + test + docker-release
#   GitHub Release published      →  full pipeline  (validate-tag + test + docker-release)
#   Manual dispatch               →  full pipeline
#
# Branch CI (push to main / dev without a tag) is handled by ci.yml.
#
# HOW TO RELEASE
# ──────────────
#   1. Do work on dev, merge dev → main via PR.
#   2. On main, apply a semver tag and push it:
#        git tag -a v1.2.3 -m "Release notes"
#        git push origin v1.2.3
#   3. GitHub Actions fires → validate → test → build → push Docker Hub.
#
# SEMVER CHEAT-SHEET
# ──────────────────
#   v0.0.x   PATCH  — bug fix, security patch, typo correction
#   v0.x.0   MINOR  — new feature, new endpoint  (backward-compatible)
#   vx.0.0   MAJOR  — breaking change (renamed/removed API, auth flow change)
#
#   v1.2.3-rc.1    release candidate  → pre-release, "latest" NOT moved
#   v1.2.3-beta.1  beta               → pre-release, "latest" NOT moved
#
# JOB PIPELINE
# ────────────
#   validate-tag  →  test  →  docker-release (gated — see conditions below)
#
#   validate-tag   verifies strict semver, exposes `version` + `is_prerelease`
#   test           restores, builds, and runs the full test suite
#   docker-release builds the Docker image, applies semver tags, pushes to Docker Hub
#                  Skipped when tag originates from dev (build-and-test only).
# ─────────────────────────────────────────────────────────────────────────────
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'        # stable:      v1.2.3
      - 'v[0-9]+.[0-9]+.[0-9]+-*'      # pre-release: v1.2.3-rc.1

  release:
    types: [published]    # legacy: fires when a GitHub Release is published

  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for manual trigger (optional)"
        required: false
        default: "Manual release"

# Least-privilege: jobs only need to read repo contents.
permissions:
  contents: read

# Serialise Docker releases so concurrent tag pushes don't race to update
# the "latest" tag on Docker Hub. Only one docker-release runs at a time;
# any job that arrives while another is running will queue and run after.
# concurrency:
#   group: docker-release
#   cancel-in-progress: false

# Cancel any previous in-progress run for the same ref (tag).
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKERHUB_IMAGE: kuthchi/monolithic-api
  DOTNET_VERSION: "10.0.x"

# ─────────────────────────────────────────────────────────────────────────────
jobs:

  # ───────────────────────────────────────────────────────────────────────────
  # JOB 0 — Validate the semver tag
  #
  # • Enforces strict vMAJOR.MINOR.PATCH or vMAJOR.MINOR.PATCH-pre.N format.
  # • Fails fast with a clear error before any build work starts.
  # • Guards the entire pipeline: downstream jobs skip when this is skipped.
  # • Exposes two outputs consumed by docker-release:
  #     version        e.g. "1.2.3" or "1.2.3-rc.1"  (v-prefix stripped)
  #     is_prerelease  "true" | "false"
  # ───────────────────────────────────────────────────────────────────────────
  validate-tag:
    name: Validate Semver Tag
    runs-on: ubuntu-latest
    # Fires on: tag push, GitHub Release publish, or manual dispatch
    if: |
      startsWith(github.ref, 'refs/tags/') ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'release'
    outputs:
      version: ${{ steps.parse.outputs.version }}
      is_prerelease: ${{ steps.parse.outputs.is_prerelease }}

    steps:
      - name: Parse & validate semver tag
        id: parse
        run: |
          TAG="${{ github.ref_name }}"

          # Strict semver: vMAJOR.MINOR.PATCH  or  vMAJOR.MINOR.PATCH-identifier.N
          SEMVER_RE='^v([0-9]+)\.([0-9]+)\.([0-9]+)(-[a-zA-Z][a-zA-Z0-9]*(\.[0-9]+)*)?$'

          if [[ ! "$TAG" =~ $SEMVER_RE ]]; then
            echo "::error::Tag '$TAG' is not valid semver."
            echo "::error::Expected: v1.2.3 (stable) or v1.2.3-rc.1 / v1.2.3-beta.2 (pre-release)"
            echo "::error::Rules — PATCH: fixes | MINOR: new features | MAJOR: breaking changes"
            exit 1
          fi

          VERSION="${TAG#v}"    # strip leading 'v'

          IS_PRERELEASE="false"
          if [[ "$TAG" =~ -[a-zA-Z] ]]; then
            IS_PRERELEASE="true"
          fi

          echo "version=$VERSION"            >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$IS_PRERELEASE" >> "$GITHUB_OUTPUT"

          if [[ "$IS_PRERELEASE" == "true" ]]; then
            echo "Pre-release: $VERSION  (latest tag will NOT be updated)"
          else
            echo "Stable release: $VERSION  (latest tag WILL be updated)"
          fi

  # ───────────────────────────────────────────────────────────────────────────
  # JOB 1 — Build & test the .NET solution
  #         Skipped automatically if validate-tag is skipped or fails.
  # ───────────────────────────────────────────────────────────────────────────
  test:
    name: Build & Test (.NET 10.0.x)
    runs-on: ubuntu-latest
    needs: validate-tag

    steps:
      - name: Checkout source
        uses: actions/checkout@v5

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore NuGet packages
        run: dotnet restore Monolithic.slnx

      - name: Build — Release
        run: dotnet build Monolithic.slnx --configuration Release --no-restore

      - name: Run tests
        run: dotnet test Monolithic.slnx --configuration Release --no-build --verbosity normal

  # ───────────────────────────────────────────────────────────────────────────
  # JOB 2 — Build Docker image and push to Docker Hub
  #         Skipped automatically if validate-tag or test fails.
  #
  # IMAGE TAGGING STRATEGY
  # ──────────────────────
  # Stable release  v1.2.3  →  Docker Hub receives:
  #
  #   kuthchi/monolithic-api:1.2.3      immutable exact version  ← pin this in prod
  #   kuthchi/monolithic-api:1.2        floating minor  (latest patch of 1.2.x)
  #   kuthchi/monolithic-api:1          floating major  (latest of 1.x.x)
  #   kuthchi/monolithic-api:latest     always the latest stable release
  #   kuthchi/monolithic-api:sha-abc123 exact build SHA for rollbacks
  #
  # Pre-release  v1.2.3-rc.1  →  Docker Hub receives:
  #
  #   kuthchi/monolithic-api:1.2.3-rc.1  exact pre-release version
  #   kuthchi/monolithic-api:sha-abc123   exact build SHA
  #   (major / minor / latest are NOT updated — stable consumers unaffected)
  # ───────────────────────────────────────────────────────────────────────────
  docker-release:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [validate-tag, test]
    # Gate: only execute the Docker stages when the tag originates from main,
    # a GitHub Release is published on main, or this workflow is triggered manually.
    # Tags pushed from dev run only validate-tag + test (no image push).
    if: |
      needs.validate-tag.result == 'success' &&
      needs.test.result == 'success' &&
      (
        github.event.base_ref == 'refs/heads/main' ||
        github.event_name == 'release' ||
        github.event_name == 'workflow_dispatch'
      )

    steps:
      - name: Checkout source
        uses: actions/checkout@v5

      # Derives all semver tags and OCI-standard labels from the Git context.
      # latest=auto → only promoted for stable (non-pre-release) tags.
      - name: Compute Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_IMAGE }}
          flavor: |
            latest=auto
          tags: |
            # Full semver:  1.2.3  or  1.2.3-rc.1
            type=semver,pattern={{version}}

            # Minor float:  1.2  (stable only — auto-skipped for pre-releases)
            type=semver,pattern={{major}}.{{minor}}

            # Major float:  1  (stable only — auto-skipped for pre-releases)
            type=semver,pattern={{major}}

            # Short SHA:  sha-abc1234  (every build — rollback reference)
            type=sha,prefix=sha-,format=short
          labels: |
            org.opencontainers.image.title=Monolithic API
            org.opencontainers.image.description=Monolithic business API service
            org.opencontainers.image.version=${{ needs.validate-tag.outputs.version }}
            org.opencontainers.image.vendor=kuth-chi
            org.opencontainers.image.licenses=MIT

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build once, push all computed tags in a single layer-cached pass.
      # VERSION build-arg lets the app embed its own version string at compile time.
      - name: Build & push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/Monolithic.Api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.validate-tag.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Job summary
        run: |
          IS_PRE="${{ needs.validate-tag.outputs.is_prerelease }}"
          if [[ "$IS_PRE" == "true" ]]; then
            RELEASE_TYPE="Pre-release  (latest NOT updated)"
          else
            RELEASE_TYPE="Stable  (latest updated)"
          fi

          echo "## Docker Release Summary"                                                          >> $GITHUB_STEP_SUMMARY
          echo ""                                                                                    >> $GITHUB_STEP_SUMMARY
          echo "| Field          | Value |"                                                          >> $GITHUB_STEP_SUMMARY
          echo "|---|---|"                                                                            >> $GITHUB_STEP_SUMMARY
          echo "| Release type   | \`$RELEASE_TYPE\` |"                                             >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | \`${{ github.event.release.name }}\` |"                          >> $GITHUB_STEP_SUMMARY
          echo "| Version        | \`${{ needs.validate-tag.outputs.version }}\` |"                 >> $GITHUB_STEP_SUMMARY
          echo "| Release tag    | \`${{ github.ref_name }}\` |"                                    >> $GITHUB_STEP_SUMMARY
          echo "| Target branch  | \`${{ github.event.release.target_commitish }}\` |"              >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA     | \`${{ github.sha }}\` |"                                         >> $GITHUB_STEP_SUMMARY
          echo ""                                                                                    >> $GITHUB_STEP_SUMMARY
          echo "**Published Docker tags:**"                                                          >> $GITHUB_STEP_SUMMARY
          echo '```'                                                                                 >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}"                                                     >> $GITHUB_STEP_SUMMARY
          echo '```'                                                                                 >> $GITHUB_STEP_SUMMARY
